{% extends 'layout/base.html.twig' %}

{% block title %}{{ currentCategoryLabel ? currentCategoryLabel ~ ' - ' : '' }}Produtos - ec-hub{% endblock %}

{% block content %}
<main class="product-listing">
    <header class="product-listing__header">
        <h1 class="product-listing__title">{{ currentCategoryLabel ? currentCategoryLabel : 'Catálogo de Produtos' }}</h1>
        <p class="product-listing__count">
            {{ totalProducts }} {{ currentCategoryLabel ? 'produto' ~ (totalProducts > 1 ? 's' : '') ~ ' em ' ~ currentCategoryLabel : 'produto' ~ (totalProducts > 1 ? 's' : '') ~ ' encontrado' ~ (totalProducts > 1 ? 's' : '') }}
        </p>
    </header>

    <div class="product-listing__skeleton" aria-hidden="true">
        {% for i in 1..4 %}
        <article class="product-listing__skeleton-card">
            <div class="skeleton skeleton--image"></div>
            <div class="skeleton skeleton--text"></div>
            <div class="skeleton skeleton--text-sm"></div>
        </article>
        {% endfor %}
    </div>

    {% if categories is defined and categories is not empty %}
    <aside class="category-filter" aria-label="Filtro de categoria">
        <h2 class="category-filter__title">Categorias</h2>
        <nav class="category-filter__nav">
            <a href="/products" class="category-filter__link {{ currentCategory is null ? 'category-filter__link--active' : '' }}" {{ currentCategory is null ? 'aria-current="page"' : '' }}>Todos os produtos <span class="category-filter__count">{{ totalAllProducts }}</span></a>
            {% for category, count in categories %}
            <a href="?category={{ category|url_encode }}" class="category-filter__link {{ currentCategory == category ? 'category-filter__link--active' : '' }}" {% if currentCategory == category %}aria-current="page"{% endif %}>{{ category }} <span class="category-filter__count">{{ count }}</span></a>
            {% endfor %}
        </nav>
    </aside>
    {% endif %}

    {% if products is not empty %}
    <div class="product-grid">
        {% for product in products %}
            {% set imageUrl = product.image_url %}
            {% set separator = ('?' in imageUrl) ? '&' : '?' %}
            {% set srcsetList = [
                imageUrl ~ separator ~ 'w=400 400w',
                imageUrl ~ separator ~ 'w=600 600w',
                imageUrl ~ separator ~ 'w=800 800w'
            ] %}
            {% set productIdentifier = (product.slug ?? product.id)|url_encode %}
            <article class="product-card">
                <a href="/products/{{ productIdentifier }}" class="product-card__link">
                    <img
                        src="{{ imageUrl }}"
                        srcset="{{ srcsetList|join(', ') }}"
                        sizes="
                            (max-width: 767px) 100vw,
                            (max-width: 1023px) 50vw,
                            33vw
                        "
                        alt="{{ product.name }}"
                        class="product-card__image"
                        loading="lazy"
                        width="400"
                        height="300"
                        onerror="this.src='https://placehold.co/400x300/FF6B6B/ffffff?text=Sem+imagem'"
                    />
                    <div class="product-card__content">
                        <h3 class="product-card__name">{{ product.name }}</h3>
                        <span class="product-card__category">{{ product.category }}</span>
                        <span class="product-card__price">
                            R$ {{ product.price|number_format(2, ',', '.') }}
                        </span>
                    </div>
                </a>
            </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="product-listing__empty">
        <p class="product-listing__empty-title">Nenhum produto encontrado{% if currentCategoryLabel %} para "{{ currentCategoryLabel }}"{% endif %}.</p>
        <p class="product-listing__empty-subtitle">Tente outra categoria ou veja todos os produtos.</p>
        <a href="/products" class="product-listing__empty-link">&larr; Ver todos os produtos</a>
    </div>
    {% endif %}

{% set paginationBase = paginationBaseQuery ?? '' %}
{% set querySuffix = paginationBase ? '&' ~ paginationBase : '' %}

    {% if totalPages >= 1 %}
        <nav class="pagination" aria-label="Paginação">
            {% if currentPage > 1 %}
                <a href="?page={{ currentPage - 1 }}{{ querySuffix }}" class="pagination__prev">
                    &larr; Anterior
                </a>
            {% endif %}

            <span class="pagination__info">
                Página {{ currentPage }} de {{ totalPages }}
            </span>

            {% if currentPage < totalPages %}
                <a href="?page={{ currentPage + 1 }}{{ querySuffix }}" class="pagination__next">
                    Próxima &rarr;
                </a>
            {% endif %}
        </nav>
    {% endif %}

    {% if renderTime is defined %}
        <p class="product-listing__debug">
            Renderizado em {{ renderTime|number_format(2) }}ms
        </p>
    {% endif %}
</main>
{% endblock %}
