{% extends 'layout/base.html.twig' %}

{% block title %}{{ currentCategory ? currentCategory ~ ' - ' : '' }}Produtos - ec-hub{% endblock %}

{% block content %}
<main class="product-listing">
    <header class="product-listing__header">
        <h1 class="product-listing__title">{{ currentCategory ? currentCategory : 'Catálogo de Produtos' }}</h1>
        <p class="product-listing__count">
            {{ totalProducts }} {{ currentCategory ? 'produto' ~ (totalProducts > 1 ? 's' : '') ~ ' em ' ~ currentCategory : 'produto' ~ (totalProducts > 1 ? 's' : '') ~ ' encontrado' ~ (totalProducts > 1 ? 's' : '') }}
        </p>
    </header>

    {% if categories is defined and categories is not empty %}
    <aside class="category-filter" aria-label="Filtro de categoria">
        <h2 class="category-filter__title">Categorias</h2>
        <nav class="category-filter__nav">
            <a href="/products" class="category-filter__link {{ currentCategory is null ? 'category-filter__link--active' : '' }}">
                Todos os produtos <span class="category-filter__count">{{ totalAllProducts }}</span>
            </a>
            {% for category, count in categories %}
            <a href="?category={{ category|url_encode }}" class="category-filter__link {{ currentCategory == category ? 'category-filter__link--active' : '' }}">
                {{ category }} <span class="category-filter__count">{{ count }}</span>
            </a>
            {% endfor %}
        </nav>
    </aside>
    {% endif %}

    <div class="product-grid">
        {% for product in products %}
            {% set productIdentifier = (product.slug ?? product.id)|url_encode %}
            <article class="product-card">
                <a href="/products/{{ productIdentifier }}" class="product-card__link">
                    <img
                        src="{{ product.image_url }}"
                        alt="{{ product.name }}"
                        class="product-card__image"
                        loading="lazy"
                        onerror="this.src='https://placehold.co/400x300/FF6B6B/ffffff?text=Sem+imagem'"
                    />
                    <div class="product-card__content">
                        <h2 class="product-card__name">{{ product.name }}</h2>
                        <span class="product-card__category">{{ product.category }}</span>
                        <span class="product-card__price">
                            R$ {{ product.price|number_format(2, ',', '.') }}
                        </span>
                    </div>
                </a>
            </article>
        {% endfor %}
    </div>

    {% set paginationBase = paginationBaseQuery ?? '' %}
    {% set queryPrefix = paginationBase ? paginationBase ~ '&' : '' %}

    {% if totalPages >= 1 %}
        <nav class="pagination" aria-label="Paginação">
            {% if currentPage > 1 %}
                <a href="?{{ queryPrefix }}page={{ currentPage - 1 }}" class="pagination__prev">
                    &larr; Anterior
                </a>
            {% endif %}

            <span class="pagination__info">
                Página {{ currentPage }} de {{ totalPages }}
            </span>

            {% if currentPage < totalPages %}
                <a href="?{{ queryPrefix }}page={{ currentPage + 1 }}" class="pagination__next">
                    Próxima &rarr;
                </a>
            {% endif %}
        </nav>
    {% endif %}

    {% if renderTime is defined %}
        <p class="product-listing__debug">
            Renderizado em {{ renderTime|number_format(2) }}ms
        </p>
    {% endif %}
</main>
{% endblock %}
